<project basedir="../.." default="separate-jars">
	<import>
		<url url="http://dkpro-core-asl.googlecode.com/svn/built-ant-macros/tags/0.1.0/ant-macros.xml"/>
	</import>
	
	<property name="postagger.version" value="20120106"/>
	<property name="postagger.date" value="2012-01-06"/>
	<property name="core.version" value="20120108"/>
	<property name="core.date" value="2012-01-08"/>
	<property name="parser.version" value="20120203"/>
	<property name="parser.date" value="2012-02-03"/>
	
	<target name="local-maven">
		<property name="install-artifact-enable" value="true"/>
		<antcall target="separate-jars"/>
	</target>
	
	<target name="separate-jars" depends="separate-jars-parser, separate-jars-postagger, separate-jars-ner, separate-jars-dcoref"/>
		
	<target name="separate-jars-postagger">
		<property name="outputDir" value="target/model-staging/de/tudarmstadt/ukp/dkpro/core/stanfordnlp"/>
		<antcall target="download-postagger"/>
		
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/postagger/arabic-accurate.tagger" md5="730f09c873334d7ea1dc319aeac8b827"
    		tool="postagger" language="ar" variant="accurate" extension="tagger" version="${postagger.version}"/>		
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/postagger/arabic-fast.tagger" md5="cc88707a0f57a2a303b40428d96a5853"
    		tool="postagger" language="ar" variant="fast" extension="tagger" version="${postagger.version}"/>		
		
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/postagger/chinese.tagger" md5="77b63c53d00e92ac669d8daf5418e652"
    		tool="postagger" language="zh" variant="default" extension="tagger" version="${postagger.version}"/>	
		
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/postagger/german-dewac.tagger" md5="9b131f68fec38e168211f565db6d2bf5"
    		tool="postagger" language="de" variant="dewac" extension="tagger" version="${postagger.version}"/>		
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/postagger/german-hgc.tagger" md5="f83e545f0ded54937c88c3ba62b6f0c0"
    		tool="postagger" language="de" variant="hgc" extension="tagger" version="${postagger.version}"/>		
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp" 
    		file="target/download/postagger/german-fast.tagger" md5="8494b5e56c1545cca77bf7faf7b9967c"
    		tool="postagger" language="de" variant="fast" extension="tagger" version="${postagger.version}"/>		

    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/postagger/english-bidirectional-distsim.tagger" md5="9505d180a60de4a4abb72c95f794f1a2"
    		tool="postagger" language="en" variant="bidirectional-distsim" extension="tagger" version="${postagger.version}"/>		
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/postagger/english-left3words-distsim.tagger" md5="ea935d509091eefe881bb845379b1f5b"
    		tool="postagger" language="en" variant="left3words-distsim" extension="tagger" version="${postagger.version}"/>	
		
		<antcall target="download-core"/>
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/core/wsj-0-18-bidirectional-distsim.tagger" md5="ad465a43281c196c8aadee1adaab9251"
    		tool="postagger" language="en" variant="bidirectional-distsim-wsj-0-18" extension="tagger" version="${core.version}"/>		
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/core/wsj-0-18-left3words-distsim.tagger" md5="7c4f532935a2de5c1548efb142b1c268"
    		tool="postagger" language="en" variant="left3words-distsim-wsj-0-18" extension="tagger" version="${core.version}"/>		
	</target>

	<target name="separate-jars-ner">
		<property name="outputDir" value="target/model-staging/de/tudarmstadt/ukp/dkpro/core/stanfordnlp"/>
		<antcall target="download-core"/>
		<antcall target="download-german-ner"/>

    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/core/muc.distsim.crf.ser.gz" md5="947710871ee62cbe94e8b21f2c934581"
    		tool="ner" language="en" variant="muc.distsim.crf" extension="ser.gz" version="${core.version}"/>		

    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/core/conll.distsim.crf.ser.gz" md5="bac8f4552bb6875f53a28d2803034fc5"
    		tool="ner" language="en" variant="conll.distsim.crf" extension="ser.gz" version="${core.version}"/>		

		<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
			file="target/download/core/all.3class.distsim.crf.ser.gz" md5="163502a20d89b686767281dc001cc55f"
    		tool="ner" language="en" variant="all.3class.distsim.crf" extension="ser.gz" version="${core.version}"/>	

		<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp" 
			file="target/download/german-ner/hgc_175m_600.crf.ser.gz" md5="39861454dc9e3b2eb391dd5b7139bc1b"
    		tool="ner" language="de" variant="hgc_175m_600.crf" extension="ser.gz" version="20110920"/>		
		
		<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp" 
			file="target/download/german-ner/dewac_175m_600.crf.ser.gz" md5="4722078875ddd5658f37e496f4b54b1d"
    		tool="ner" language="de" variant="dewac_175m_600.crf" extension="ser.gz" version="20110920"/>	
	</target>
			
	<target name="separate-jars-parser">
		<property name="outputDir" value="target/model-staging/de/tudarmstadt/ukp/dkpro/core/stanfordnlp"/>
		<antcall target="download-parser"/>
		
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/parser/englishPCFG.ser.gz" md5="1d203d00e6c2611053c837013681a8f9"
    		tool="lexparser" language="en" variant="pcfg" extension="ser.gz" version="${parser.version}"/>		

    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/parser/englishFactored.ser.gz" md5="3bc5a0843208447989904cbc77a4eed9"
    		tool="lexparser" language="en" variant="factored" extension="ser.gz" version="${parser.version}"/>		
		
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/parser/germanPCFG.ser.gz" md5="33f915f9c46a2d02a46fd55dbc23b64e"
    		tool="lexparser" language="de" variant="pcfg" extension="ser.gz" version="${parser.version}"/>		

    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/parser/germanFactored.ser.gz" md5="ac4cc5cc3b1e9a28fe46b2afad0c47d3"
    		tool="lexparser" language="de" variant="factored" extension="ser.gz" version="${parser.version}"/>		

    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/parser/chinesePCFG.ser.gz" md5="362033349729ce25e5691c58c6e83e92"
    		tool="lexparser" language="zh" variant="pcfg" extension="ser.gz" version="${parser.version}"/>		

    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/parser/chineseFactored.ser.gz" md5="d1d0fee57e1f69412052db6075ad6ab6"
    		tool="lexparser" language="zh" variant="factored" extension="ser.gz" version="${parser.version}"/>		

    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/parser/arabicFactored.ser.gz" md5="c0f6b49dbd68cb1e5466bbc6583bde95"
    		tool="lexparser" language="ar" variant="factored" extension="ser.gz" version="${parser.version}"/>		
		
    	<install-model-file groupId="de.tudarmstadt.ukp.dkpro.core" artifactIdBase="de.tudarmstadt.ukp.dkpro.core.stanfordnlp"
    		file="target/download/parser/frenchFactored.ser.gz" md5="dea5c0b9e4f7d47ac30af0921497334d"
    		tool="lexparser" language="fr" variant="factored" extension="ser.gz" version="${parser.version}"/>		
	</target>

	<target name="separate-jars-dcoref">
		<property name="outputDir" value="target/model-staging/de/tudarmstadt/ukp/dkpro/core/stanfordnlp"/>

		<mkdir dir="${outputDir}/lib"/>

		<clean-pom/>
		<generate-pom version="${core.version}" groupId="de.tudarmstadt.ukp.dkpro.core" 
			artifactId="de.tudarmstadt.ukp.dkpro.core.stanfordnlp-model-dcoref-en"/>
		
		<copy todir="${outputDir}/lib">
			<fileset dir="target/download/core/">
				<include name="dcoref-en/**/*"/>
			</fileset>
		</copy>
		
		<jar destfile="target/de.tudarmstadt.ukp.dkpro.core.stanfordnlp-model-dcoref-en-${core.version}.jar" compress="true">
			<fileset dir="target/model-staging">
				<include name="META-INF/**/*"/>
				<include name="**/lib/dcoref-en/*"/>
			</fileset>
		</jar>
		
		<install-artifact file="target/de.tudarmstadt.ukp.dkpro.core.stanfordnlp-model-dcoref-en-${core.version}.jar"
			groupId="de.tudarmstadt.ukp.dkpro.core" artifactId="de.tudarmstadt.ukp.dkpro.core.stanfordnlp-model-dcoref-en"
			version="${core.version}"/>
		
		<clean-pom/>
	</target>

	<target name="download-german-ner">
		<mkdir dir="target/download/german-ner"/>
		<get src="http://nlp.stanford.edu/software/ner.german.tgz" dest="target/download/german-ner/ner.german.tar.gz" skipexisting="true"/>
    	<gunzip src="target/download/german-ner/ner.german.tar.gz"/>
    	<untar src="target/download/german-ner/ner.german.tar" dest="target/download/german-ner">
    		<chainedmapper>
	    		<mapper type="flatten"/>
    		</chainedmapper>
    	</untar>
    	<delete file="target/download/german-ner/ner.german.tar"/>
	</target>
	
	<target name="download-core">
		<mkdir dir="target/download/core"/>
    	<get src="http://nlp.stanford.edu/software/stanford-corenlp-${core.date}.tgz" dest="target/download/core/core-nlp.tar.gz" skipexisting="true"/>
    	<gunzip src="target/download/core/core-nlp.tar.gz"/>
    	<untar src="target/download/core/core-nlp.tar" dest="target/download/core">
    		<patternset>
    			<include name="**/stanford-corenlp-*-models.jar"/>		
			</patternset>
    		<chainedmapper>
	    		<mapper type="flatten"/>
	    		<firstmatchmapper>
					<globmapper from="*" to="stanford-corenlp-models.jar"/>
				</firstmatchmapper>
    		</chainedmapper>
    	</untar>
		<unzip src="target/download/core/stanford-corenlp-models.jar" dest="target/download/core">
    		<patternset>
    			<include name="**/*.ser.gz"/>		
    			<include name="**/*.tagger*"/>		
			</patternset>
    		<chainedmapper>
	    		<mapper type="flatten"/>
    		</chainedmapper>
		</unzip>
		<unzip src="target/download/core/stanford-corenlp-models.jar" dest="target/download/core/dcoref-en">
    		<patternset>
    			<include name="**/dcoref/*"/>		
			</patternset>
    		<chainedmapper>
	    		<mapper type="flatten"/>
    		</chainedmapper>
		</unzip>
    	<delete file="target/download/core/stanford-corenlp-models.jar"/>
    	<!--delete file="target/download/core/core-nlp.tar.gz"/-->
    	<delete file="target/download/core/core-nlp.tar"/>
	</target>

	<target name="download-parser">
		<mkdir dir="target/download/parser"/>
    	<get src="http://nlp.stanford.edu/software/stanford-parser-${parser.date}.tgz" dest="target/download/parser/parser.tar.gz" skipexisting="true"/>
    	<gunzip src="target/download/parser/parser.tar.gz"/>
    	<untar src="target/download/parser/parser.tar" dest="target/download/parser">
    		<patternset>
    			<include name="**/grammar/**/*.ser.gz"/>		
			</patternset>
    		<chainedmapper>
	    		<mapper type="flatten"/>
    		</chainedmapper>
    	</untar>
    	<!--delete file="target/download/parser/parser.tar.gz"/-->
    	<delete file="target/download/parser/parser.tar"/>
	</target>

	<target name="download-postagger">
		<mkdir dir="target/download/postagger"/>
    	<get src="http://nlp.stanford.edu/software/stanford-postagger-full-${postagger.date}.tgz" dest="target/download/postagger/postagger.tar.gz" skipexisting="true"/>
	   	<gunzip src="target/download/postagger/postagger.tar.gz"/>
    	<untar src="target/download/postagger/postagger.tar" dest="target/download/postagger">
    		<patternset>
    			<include name="**/models//*.tagger*"/>		
			</patternset>
    		<chainedmapper>
	    		<mapper type="flatten"/>
    		</chainedmapper>
    	</untar>
    	<!--delete file="target/download/parser/postagger.tar.gz"/-->
    	<delete file="target/download/parser/postagger.tar"/>
	</target>

	<macrodef name="install-model-file">
		<attribute name="file"/>
		<attribute name="groupId"/>
		<attribute name="artifactIdBase"/>
		<attribute name="extension"/>
		<attribute name="variant"/>
		<attribute name="tool"/>
		<attribute name="language"/>
		<attribute name="version"/>
		<attribute name="md5"/>
		<attribute name="prop.verify.md5" default="verify.md5.@{tool}.@{language}.@{variant}"/>
		<attribute name="prop.verify.md5.actual" default="verify.md5.actual.@{tool}.@{language}.@{variant}"/>
		<sequential>
			<fail unless="outputDir">No output directory set.</fail>
	    	<mkdir dir="${outputDir}/lib"/>
			<copy file="@{file}" tofile="${outputDir}/lib/@{tool}-@{language}-@{variant}.@{extension}"/>
			<copy file="@{file}.props" tofile="${outputDir}/lib/@{tool}-@{language}-@{variant}.@{extension}.props" failonerror="false"/>
			
			<generate-model-properties tool="@{tool}" language="@{language}" variant="@{variant}"
				extension="@{extension}"/>
			<clean-pom/>
			<generate-pom version="@{version}" groupId="@{groupId}" 
				artifactId="@{artifactIdBase}-model-@{tool}-@{language}-@{variant}"/>
			
			<checksum file="${outputDir}/lib/@{tool}-@{language}-@{variant}.@{extension}" property="@{md5}" verifyproperty="@{prop.verify.md5}"/>
			<checksum file="${outputDir}/lib/@{tool}-@{language}-@{variant}.@{extension}" property="@{prop.verify.md5.actual}"/>
			<condition property="checksum.mismatch">
				<equals arg1="false" arg2="${@{prop.verify.md5}}"/>
			</condition>
			<fail if="checksum.mismatch">
MD5 checksum mismatch for @{tool}-@{language}-@{variant}.@{extension}.
Please verify the checksum and if necessary update this script.
Expected: @{md5}
Actual  : ${@{prop.verify.md5.actual}}
			</fail>

			<jar destfile="target/@{artifactIdBase}-model-@{tool}-@{language}-@{variant}-@{version}.jar" compress="true">
				<fileset dir="target/model-staging">
					<include name="META-INF/**/*"/>
					<include name="**/lib/@{tool}-@{language}-@{variant}*"/>
				</fileset>
			</jar>
			
			<install-artifact file="target/@{artifactIdBase}-model-@{tool}-@{language}-@{variant}-@{version}.jar"
				groupId="@{groupId}" artifactId="@{artifactIdBase}-model-@{tool}-@{language}-@{variant}" version="@{version}"/>
			
			<clean-pom/>
		</sequential>
	</macrodef>

	<macrodef name="generate-model-properties">
		<attribute name="tool"/>
		<attribute name="language"/>
		<attribute name="extension"/>
		<attribute name="variant"/>
		<attribute name="prop.checksum.md5" default="checksum.md5.@{tool}-@{language}-@{variant}"/>
		<attribute name="prop.checksum.sha1" default="checksum.sha1.@{tool}-@{language}-@{variant}"/>
		<sequential>
			<checksum file="${outputDir}/lib/@{tool}-@{language}-@{variant}.@{extension}" property="@{prop.checksum.md5}"
				algorithm="MD5"/>
			<checksum file="${outputDir}/lib/@{tool}-@{language}-@{variant}.@{extension}" property="@{prop.checksum.sha1}"
				algorithm="SHA"/>
			<propertyfile file="${outputDir}/lib/@{tool}-@{language}-@{variant}.properties"
				comment="Stanford NLP tools model description">
				<entry  key="downloaded" type="date" value="now"/>
				<entry  key="tool" value="@{tool}"/>
				<entry  key="language" value="@{language}"/>
				<entry  key="variant" value="@{variant}"/>
				<entry  key="md5" value="${@{prop.checksum.md5}}"/>
				<entry  key="sha1" value="${@{prop.checksum.sha1}}"/>
			</propertyfile>
			<echo>Installed @{tool} model file for @{language} in variant @{variant}</echo>
		</sequential>
	</macrodef>
</project>